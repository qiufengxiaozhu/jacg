<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zte.zudp.admin.mm.queinvest.dao.MMQueinvestDao">



<!--问卷列表-->
<select id="selectAll" resultType="com.zte.zudp.admin.mm.queinvest.entity.MMQueinvest">

    select
    t1.id id,
    t1.title title,
    DATE_FORMAT(t1.pubdate,'%Y-%m')  yearStr,
    DATE_FORMAT(t1.pubdate,'%d')  dayStr,
    t1.description description,
    t1.status status,
    t2.user_id userPhohe
    from jacg_queinvest t1
    left join jacg_answers t2 on queinvestId = t1.id
    where status = '2'
    and  t1.id not in (select queinvestId from jacg_answers where user_id =#{userPhone})

</select>



<!--查询出完整问卷信息-->
    <select id="startQueinvest" resultType="com.zte.zudp.admin.mm.queinvest.entity.MMQueinvest">
        select
            @n:=@n+1 rowNum,
            t1.id id,
            t1.title title,
            t2.contents contents,
            t3.choiceText01 choiceText01 ,
            t3.choiceText02 choiceText02,
            t3.choiceText03 choiceText03,
            t3.choiceText04 choiceText04,
            t2.id questionId


        from  jacg_queinvest t1

        left join  jacg_questions t2 on  t1.id = t2.queinvest_id

        left join jacg_options t3 on  t2.id =  t3.questions_id

        inner join (select @n:= 0) d

        where t1.del != 1   and t1.id = #{id}

    </select>

    <!--根据所选答案，查询出所有的信息-->
    <select id="selectAllByAnswer" resultType="com.zte.zudp.admin.mm.queinvest.entity.MMQueinvest">
        SELECT
	t1.title title,
	t2.contents contents,
	t1.id queinvestId,
	t2.id questionId

FROM
	jacg_queinvest t1
	LEFT JOIN jacg_questions t2 ON t1.id = t2.queinvest_id
	LEFT JOIN jacg_options t3 ON t2.id = t3.questions_id
	LEFT JOIN jacg_answers t4 ON t2.id = t4.questions_id
	AND t4.options_id = t3.id

	where
	t3.choiceText01 =#{str} or
	t3.choiceText02 =#{str} or
	t3.choiceText03 =#{str} or
	t3.choiceText04 =#{str}



    </select>

   <!-- 将获得的答案 ，问卷id，题目id新增到答案表中-->
<insert id="insertToAnswer" >

    insert into  jacg_answers
      (id,
       queinvestId,
       answerOption,
       questions_id,
       user_id

      )
      VALUE (
        #{id},
        #{queinvestId},
        #{optContext},
        #{questionId},
        #{userPhone}
      )

</insert>





</mapper>